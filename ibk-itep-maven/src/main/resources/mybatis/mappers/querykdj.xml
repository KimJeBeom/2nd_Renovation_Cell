<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="querykdj">
	<select id="selectEduNow" parameterType="String" resultType="EduNowVo">
	     <![CDATA[
			/*수강중인 교육 조회*/
			SELECT 
			@ROWNUM := @ROWNUM + 1 AS rownum,
			EDA.EDCT_APLC_ID AS edctAplcId, -- 교육신청id
			EDM.EDCT_ID AS edctId, -- 교육id
			EDA.EDCT_CNT_ID AS edctCntId, -- 차수id
			EDA.USER_ID AS userId, -- 신청자명
			EDM.EDCT_NM AS edctNm, -- 교육명
			CLI.EDIN_NM AS edinNm, -- 교육기관명
			DATE_FORMAT(EDC.EDCT_STTG_YMD,'%Y.%m.%d') AS edtSttgYmd,   -- 학습시작일 
			DATE_FORMAT(EDC.EDCT_FNSH_YMD,'%Y.%m.%d') AS edctFnshYmd    -- 학습종료일
			FROM (SELECT @ROWNUM := 0) R, TB_IEP_EDA001M EDA
			LEFT JOIN TB_IEP_EDC001M EDC ON EDA.EDCT_CNT_ID = EDC.EDCT_CNT_ID
			JOIN TB_IEP_EDM001M EDM ON EDC.EDCT_ID = EDM.EDCT_ID
			JOIN TB_IEP_CLI001C CLI ON EDM.EDIN_CD = CLI.EDIN_CD
			WHERE 1=1
			AND EDA.USER_ID = #{userId} 
			AND EDA.CTCR_YN NOT IN ('Y','N')
			AND EDA.USE_YN = 'Y'
			AND EDA.APLC_STG_CD = 'APRFIN'
			AND EDC.FNSH_YN != 'Y'
			AND NOW() > EDC.EDCT_STTG_YMD
			ORDER BY EDC.EDCT_STTG_YMD
	     ]]>
	</select>

	<select id="selectNewEduApply" parameterType="String" resultType="EduNowVo">
	     <![CDATA[
			/*과정개설 신청목록 조회*/
			SELECT
			@ROWNUM := @ROWNUM + 1 AS rownum,
			APLC_ID AS aplcId, -- 신청id
			EDCT_NM AS edctNm, -- 교육명
			EDIN_NM AS edinNm, -- 기관명
			DATE_FORMAT(EDCT_STTG_YMD, '%Y.%m.%d') AS edctSttgYmd, -- 학습시작일
			DATE_FORMAT(EDCT_FNSH_YMD, '%Y.%m.%d') AS edctFnshYmd, -- 학습종료일
			DATE_FORMAT(APLC_TS, '%Y.%m.%d')  AS aplcTs, -- 신청일자
			IF(CNFA_YN = 'Y','확인','') AS cnfaYn -- 확인여부
			FROM TB_IEP_EDO001M, (SELECT @ROWNUM := 0) R
			WHERE 1=1
			AND USER_ID = #{userId}
			ORDER BY EDCT_STTG_YMD
	     ]]>
	</select>
	
	<select id="selectEduReady" parameterType="String" resultType="EduNowVo">
	     <![CDATA[
			/*수강신청 목록 조회*/
			SELECT 
			@ROWNUM := @ROWNUM + 1 AS rownum,
			EDA.EDCT_APLC_ID AS edctAplcId, -- 교육신청id
			EDM.EDCT_ID AS edctId, -- 교육id
			EDA.EDCT_CNT_ID AS edctCntId, -- 차수id
			EDA.USER_ID AS userId, -- 신청자명
			EDM.EDCT_NM AS edctNm, -- 교육명
			CLI.EDIN_NM AS edinNm, -- 교육기관명
			DATE_FORMAT(EDC.EDCT_STTG_YMD,'%Y.%m.%d') AS edtSttgYmd,   -- 학습시작일 
			DATE_FORMAT(EDC.EDCT_FNSH_YMD,'%Y.%m.%d') AS edctFnshYmd,    -- 학습종료일
			DATE_FORMAT(EDA.APLC_TS, '%Y.%m.%d')  AS aplcTs, -- 신청일시
			CLS.APLC_STG_NM AS aplcStgNm -- 신청단계명
			FROM (SELECT @ROWNUM := 0) R, TB_IEP_EDA001M EDA
			LEFT JOIN TB_IEP_EDC001M EDC ON EDA.EDCT_CNT_ID = EDC.EDCT_CNT_ID
			JOIN TB_IEP_EDM001M EDM ON EDC.EDCT_ID = EDM.EDCT_ID
			JOIN TB_IEP_CLI001C CLI ON EDM.EDIN_CD = CLI.EDIN_CD
			JOIN TB_IEP_CLS001C CLS ON EDA.APLC_STG_CD = CLS.APLC_STG_CD
			WHERE 1=1
			AND EDA.USER_ID = #{userId}
			AND EDA.APLC_STG_CD NOT IN ('EDUFIN','취소한교육')
			AND EDA.CTCR_YN NOT IN ('Y','N')
			AND EDA.USE_YN = 'Y'
			AND EDC.FNSH_YN != 'Y'
			AND NOW() < EDC.EDCT_STTG_YMD
			ORDER BY EDC.EDCT_STTG_YMD
	     ]]>
	</select>
	
	<update id="updateEduCancel" parameterType="Integer">
	     <![CDATA[
			/*수강신청 취소*/
			UPDATE TB_IEP_EDA001M 
			SET USE_YN = 'N'  -- 사용여부
			WHERE EDCT_APLC_ID = #{edctAplcId}
	     ]]>
	</update>
	
	<select id="selectEduComplete" parameterType="EduNowVo" resultType="EduNowVo">
	     <![CDATA[
			/*수강완료교육 조회*/
			SELECT 
			@ROWNUM := @ROWNUM + 1 AS rownum,
			EDA.EDCT_APLC_ID AS edctAplcId, -- 교육신청id
			EDM.EDCT_ID AS edctId, -- 교육id
			EDA.EDCT_CNT_ID AS edctCntId, -- 차수id
			EDA.USER_ID AS userId, -- 신청자명
			EDM.EDCT_NM AS edctNm, -- 교육명
			CLI.EDIN_NM AS edinNm, -- 교육기관명
			DATE_FORMAT(EDC.EDCT_STTG_YMD,'%Y.%m.%d') AS edtSttgYmd,   -- 학습시작일 
			DATE_FORMAT(EDC.EDCT_FNSH_YMD,'%Y.%m.%d') AS edctFnshYmd,    -- 학습종료일
			IF(EDA.CTCR_YN = 'Y','수료','미수료') AS ctcrYn -- 수료여부
			FROM (SELECT @ROWNUM := 0) R, TB_IEP_EDA001M EDA
			LEFT JOIN TB_IEP_EDC001M EDC ON EDA.EDCT_CNT_ID = EDC.EDCT_CNT_ID
			JOIN TB_IEP_EDM001M EDM ON EDC.EDCT_ID = EDM.EDCT_ID
			JOIN TB_IEP_CLI001C CLI ON EDM.EDIN_CD = CLI.EDIN_CD
			WHERE 1=1
			AND EDA.USER_ID = #{userId} 
			AND EDA.APLC_STG_CD = 'EDUFIN'
			AND EDA.USE_YN = 'Y'
			AND EDC.EDCT_STTG_YMD BETWEEN #{조회시작일자} AND #{조회종료일자}
			ORDER BY EDC.EDCT_STTG_YMD DESC
	     ]]>
	</select>
	
	<select id="selectEduMyHistory" parameterType="EduNowVo" resultType="EduNowVo">
	     <![CDATA[
			/*수강신청이력 조회*/
			SELECT 
			@ROWNUM := @ROWNUM + 1 AS rownum,
			EDA.EDCT_APLC_ID AS edctAplcId, -- 교육신청id
			EDM.EDCT_ID AS edctId, -- 교육id
			EDA.EDCT_CNT_ID AS edctCntId, -- 차수id
			EDA.USER_ID AS userId, -- 신청자명
			EDM.EDCT_NM AS edctNm, -- 교육명
			CLI.EDIN_NM AS edinNm, -- 교육기관명
			DATE_FORMAT(EDC.EDCT_STTG_YMD,'%Y.%m.%d') AS edtSttgYmd,   -- 학습시작일 
			DATE_FORMAT(EDC.EDCT_FNSH_YMD,'%Y.%m.%d') AS edctFnshYmd,    -- 학습종료일
			DATE_FORMAT(EDA.APLC_TS, '%Y.%m.%d')  AS aplcTs, -- 신청일시
			IF(EDC.FNSH_YN = 'Y','차수종료','') AS fnshYn, -- 차수종료여부
			CLS.APLC_STG_NM AS aplcStgNm, -- 신청단계명
			FROM (SELECT @ROWNUM := 0) R, TB_IEP_EDA001M EDA
			LEFT JOIN TB_IEP_EDC001M EDC ON EDA.EDCT_CNT_ID = EDC.EDCT_CNT_ID
			JOIN TB_IEP_EDM001M EDM ON EDC.EDCT_ID = EDM.EDCT_ID
			JOIN TB_IEP_CLI001C CLI ON EDM.EDIN_CD = CLI.EDIN_CD
			JOIN TB_IEP_CLS001C CLS ON EDA.APLC_STG_CD = CLS.APLC_STG_CD
			WHERE 1=1
			AND EDA.USER_ID = #{신청자직번} 
			AND EDC.EDCT_STTG_YMD BETWEEN #{조회시작일자} AND #{조회종료일자}
			AND EDA.USE_YN='Y'
	     ]]>
	</select>
	
	<insert id="insertNewEduRegPop" parameterType="EduNowVo">
	     <![CDATA[
			/*신규교육 등록팝업*/
			INSERT INTO TB_IEP_EDM001M(
			EDCT_ID, -- 교육id
			EDCT_NM, -- 교육명
			EDIN_CD, -- 교육기관코드
			EDCT_CLSF_CD, -- 교육분류
			SNCT_TGT_YN, -- 결재여부
			EDCT_CON,  -- 교육내용
			INBK_EDCT_YN,  -- 교육구분
			EGIN_APLY_YN, -- 고용보험여부
			ONL_EDCT_YN,  -- 온라인교육여부
			EDCT_LEVL, -- 교육수준
			USE_YN, -- 사용여부
			RGSN_TS) -- 등록일시
			VALUES(
			NULL, 
			#{ edctNm },
			#{ edinCd },
			#{ edctClsfCd },
			#{ snctTgtYn },
			#{ edctCon },
			#{ inbkEdctYn },
			#{ egingAplyYn },
			#{ onlEdctYn },
			#{ edctLevl },
			'Y',
			SYSDATE())
	     ]]>
	</insert>
	
	<select id="selectEduModPop" parameterType="Integer" resultType="EduNowVo">
	     <![CDATA[
			/*수정대상 교육 조회(팝업)*/
			SELECT 
			EDCT_ID AS edctId, -- 교육id
			EDCT_CLSF_CD as edctClsfCd, -- 교육분류코드
			SNCT_TGT_YN as snctTgtYn, -- 결재여부
			EDCT_NM as edctNm, -- 교육명
			EDCT_CON as edctCon, -- 교육내용
			EDIN_CD as edinCd, -- 교육기관코드
			INBK_EDCT_YN as inbkEdctYn, -- 교육구분
			EGIN_APLY_YN as egingAplyYn, -- 고용보험여부
			ONL_EDCT_YN as onlEdctYn, -- 교육방식
			EDCT_LEVL as edctLevl -- 교육수준
			FROM TB_IEP_EDM001M
			WHERE 1=1
			AND EDCT_ID = #{edctId} -- 교육코드
	     ]]>
	</select>
	
	<update id="updateEduModPop" parameterType="EduNowVo">
	     <![CDATA[
			/*교육내용 수정 팝업*/
			UPDATE TB_IEP_EDM001M 
			SET EDCT_CLSF_CD = #{ edctClsfCd }, -- 교육분류
			SNCT_TGT_YN = #{ snctTgtYn }, -- 결재여부
			SET EDCT_NM = #{ edctNm }, -- 교육명
			EDCT_CON = #{ edctCon }, -- 교육내용
			EDIN_CD = #{ edinCd }, -- 교육기관
			INBK_EDCT_YN = #{ inbkEdctYn }, -- 교육구분
			EGIN_APLY_YN = #{ egingAplyYn }, -- 고용보헙여부
			ONL_EDCT_YN = #{ onlEdctYn }, -- 교육방식
			EDCT_LEVL = #{ edctLevl }, -- 교육수준
			USE_YN = 'Y',
			RGSN_TS = SYSDATE()
			WHERE EDCT_ID = #{edctId} -- 교육코드
	     ]]>
	</update>
	
	<select id="selectAddEduRndPop" parameterType="Integer" resultType="EduNowVo">
	     <![CDATA[
			/*교육 차수정보 조회(팝업)*/
			SELECT 
			@ROWNUM := @ROWNUM + 1 AS rownum, -- 순번
			EDCT_CNT_ID AS edctCntId, -- 차수id
			EDCT_ID AS edctId, -- 교육id
			date_format(EDC.EDCT_STTG_YMD,"%Y.%m.%d") AS edctSttgYmd, -- 학습시작일
			date_format(EDC.EDCT_FNSH_YMD,"%Y.%m.%d") AS edctFnshYmd, -- 학숩종료일
			concat(EDC.EDCT_TRM,'일') as edctTrm -- 교육기간
			FROM TB_IEP_EDC001M EDC, (SELECT @ROWNUM := 0) R
			WHERE 1=1 
			AND EDCT_ID = #{edctId}
			AND USE_YN = 'Y' 
			ORDER BY EDCT_STTG_YMD DESC
	     ]]>
	</select>
	
	<select id="selectAddEduRndInfoPop" parameterType="EduNowVo" resultType="EduNowVo">
	     <![CDATA[
			/*특정차수 상세정보 조회(팝업)*/
			SELECT 
			 EDC.EDCT_CNT_ID AS edctCntId, -- 차수id
			 EDC.EDCT_ID AS edctId, -- 교육id
			 EDM.EDCT_NM as ectNm, -- 교육명
			 date_format(EDC.APLC_STTG_YMD,'%Y.%m.%d') as aplcSttgYmd, -- 신청시작일
			 date_format(EDC.APLC_FNSH_YMD,'%Y.%m.%d') as aplcFnshYmd, -- 신청종료일
			 date_format(EDC.CNCL_STTG_YMD,'%Y.%m.%d') as cnclStttgYmd, -- 취소시작일
			 date_format(EDC.CNCL_FNSH_YMD,'%Y.%m.%d') as cnclFnshYmd, -- 취소종료일
			 date_format(EDC.EDCT_STTG_YMD,'%Y.%m.%d') as edctSttgYmd, -- 학습시작일
			 date_format(EDC.EDCT_FNSH_YMD,'%Y.%m.%d') as edctFnshYmd, -- 학습종료일
			 date_format(EDC.EDCT_STTG_TIM,'%H:%i') as edctSttgTim, -- 교육시작시간
			 date_format(EDC.EDCT_FNSH_TIM,'%H:%i') as edctFnshTim, -- 교육종료시간
			 concat(EDC.EDCT_TRM,'일') as edctTrm, -- 교육기간
			 concat(EDC.CTCR_TIM,'시간') as ctcrTim, -- 이수시간
			 concat(format(EDC.EDEX,0),'원') as edex -- 교육비용
			FROM TB_IEP_EDC001M EDC
			INNER JOIN TB_IEP_EDM001M EDM ON EDC.EDCT_ID = EDM.EDCT_ID
			WHERE EDC.EDCT_ID = #{edctId} AND EDC.EDCT_CNT_ID = #{edctCntId} -- 교육코드, 차수코드
	     ]]>
	</select>
	
	<insert id="insertAddEduRndPop" parameterType="EduNowVo">
	     <![CDATA[
			/*교육 차수추가 팝업*/
			INSERT TB_IEP_EDC001M(
			EDCT_CNT_ID, -- 차수id
			EDCT_ID, -- 교육id
			EDCT_STTG_YMD, -- 학습시작일
			EDCT_FNSH_YMD, -- 학습종료일
			APLC_STTG_YMD, -- 등록시작일
			APLC_FNSH_YMD, -- 등록종료일
			CNCL_STTG_YMD, -- 취소시작일
			CNCL_FNSH_YMD, -- 취소종료일
			EDCT_STTG_TIM, -- 교육시작시간
			EDCT_FNSH_TIM, -- 교육종료시간 
			EDCT_TRM, -- 교육기간
			CTCR_TIM, -- 이수시간
			EDEX, -- 교육비용
			FNSH_YN, -- 차수완료여부
			USE_YN, -- 사용여부
			RGSN_TS) -- 등록일시 
			VALUES(
			NULL, 
			#{edctId}, 
			#{edctSttgYmd}, 
			#{edctFnshYmd}, 
			#{aplcSttgYmd}, 
			#{aplcFnshYmd}, 
			#{cnclStttgYmd}, 
			#{cnclFnshYmd}, 
			#{edctSttgTim}, 
			#{edctFnshTim}, 
			#{edctTrm}, 
			#{ctcrTim}, 
			#{edex}, 
			NULL, 
			'Y', 
			SYSDATE()) 
	     ]]>
	</insert>
	
	<update id="updateModEduRnd" parameterType="EduNowVo">
	     <![CDATA[
			/*교육 차수수정 팝업*/
			UPDATE TB_IEP_EDC001M
			SET EDCT_STTG_YMD = #{edctSttgYmd}, -- 학습시작일
			EDCT_FNSH_YMD = #{edctFnshYmd}, -- 학습종료일
			APLC_STTG_YMD = #{aplcSttgYmd}, -- 신청시작일
			APLC_FNSH_YMD = #{aplcFnshYmd}, -- 신청종료일
			CNCL_STTG_YMD = #{cnclStttgYmd}, -- 취소시작일
			CNCL_FNSH_YMD = #{cnclFnshYmd}, -- 취소종료일
			EDCT_STTG_TIM = #{edctSttgTim}, -- 교육시작시간
			EDCT_FNSH_TIM = #{edctFnshTim}, -- 교육종료시간
			EDCT_TRM = #{edctTrm}, -- 교육기간
			CTCR_TIM = #{ctcrTim}, -- 이수시간
			EDEX = #{edex}, -- 교육비용
			RGSN_TS = SYSDATE() -- 등록일시
			WHERE EDCT_ID = #{edctId} AND EDCT_CNT_ID = #{edctCntId} -- 교육id, 차수id
	     ]]>
	</update>
	
	<update id="updateEduDelete" parameterType="Integer">
	     <![CDATA[
			/*교육 삭제*/
			UPDATE TB_IEP_EDM001M 
			SET USE_YN = 'N' 
			WHERE EDCT_ID = #{edctId} -- 교육id
	     ]]>
	</update>
	
	<select id="selectEdinCd" resultType="EduNowVo">
	     <![CDATA[
			/*교육기관코드 조회*/
			SELECT 
			@ROWNUM := @ROWNUM + 1 AS rownum,
			'교육기관' AS cli,
			CLI.EDIN_CD AS edincd, -- 교육기관코드
			CLI.EDIN_NM AS edinNm, -- 교육기관명
			CLI.USE_YN AS useYn -- 사용여부
			FROM (SELECT @ROWNUM := 0) R, TB_IEP_CLI001C CLI
	     ]]>
	</select>
	
	<update id="updateEdinCd" parameterType="String">
	     <![CDATA[
			/*교육기관코드 수정*/
			UPDATE TB_IEP_CLI001C
			SET EDIN_NM = #{edinNm}, USE_YN = #{useYn}
			WHERE EDIN_CD = #{edinCd}
	     ]]>
	</update>
	
	<insert id="insertEdinCd" parameterType="EduNowVo">
	     <![CDATA[
			/*교육기관코드 등록*/
			INSERT INTO TB_IEP_CLI001C(
			EDIN_CD, -- 교육기관코드
			EDIN_NM, -- 교육기관명
			USE_YN) -- 사용여부
			VALUES(
			#{edinCd},
			#{edcinNm},
			'Y')
	     ]]>
	</insert>
	
	<select id="selectEdctClsfCd" resultType="EduNowVo">
	     <![CDATA[
			/*교육분류코드 조회*/
			SELECT 
			@ROWNUM := @ROWNUM + 1 AS rownum,
			'교육기관' AS cld,
			CLD.EDCT_CLSF_CD AS edctClsfCd, -- 교육분류코드
			CLD.EDCT_CLSF_NM AS edctClsfNm, -- 교육분류명
			CLD.USE_YN AS useyN
			FROM (SELECT @ROWNUM := 0) R, TB_IEP_CLD001C CLD
	     ]]>
	</select>
	
	<update id="updateEdctClsfCd" parameterType="EduNowVo">
	     <![CDATA[
			/*교육분류코드 수정*/
			UPDATE TB_IEP_CLI001C
			SET EDCT_CLSF_NM = #{edctClsfNm}, USE_YN = #{useYn}
			WHERE EDCT_CLSF_CD = #{edctClsfCd}
	     ]]>
	</update>
	
	<insert id="insertEdctClsfCd" parameterType="EduNowVo">
	     <![CDATA[
			/*교육분류코드 등록*/
			INSERT INTO TB_IEP_CLD001C(
			EDCT_CLSF_CD, -- 교육분류코드
			EDCT_CLSF_NM,  -- 교육분류명
			USE_YN)
			VALUES(
			#{edctClsfCd},
			#{edctClsfNm},
			'Y')
	     ]]>
	</insert>
</mapper>